<pre>''******************************************************************************<br>' Name:<br>' verity-health.vbs<br>'<br>' Requires:<br>' mkvdk, mapped drives for collection hosts<br>'<br>' Inputs:<br>' Control File location<br>'<br>' Usage:<br>' cscript verity-health.vbs d:\dev\scripts<br>'<br>' Purpose:<br>' Reads control files, finds Verity collections, <br>' gather stats and sends output to screen<br>'<br>' Layout:<br>' Assignment, Sets, Main, Subs, Functions<br>'<br>' Based on code copyright (c)CaseShare Systems<br>'<br>'******************************************************************************<br><br>' *******************************************************<br>' Mapped Drive Assignment<br>'     Alias = Mounted_Drive:Collection_Directory<br>' *******************************************************<br>' Change these server to drive mappings here and verify the server<br>' names match those in sub WhichMapDrive below<br>Const bean = "t:\colls"<br>Const ender = "d:\colls"<br>Const ForReading=1<br><br><br>Dim oArgs<br>Dim fso, wso<br>Dim sMKVDK, sVerityLock, sControlFilePath<br>Dim dtmDateNow, dtmTimeNow, dtmYYYY, dtmMM, dtmDD, dtmHH, dtmMN, dtmSS<br>Dim wsoReturn, wsoCommand, sControlFile, dictControlFiles<br>Dim sLogFolder, sLogFolderPath, sMkvdkLogFolderPath<br><br>Set oArgs = Wscript.Arguments<br>Set fso = CreateObject("Scripting.FileSystemObject")<br>Set wso = WScript.CreateObject("WScript.Shell")<br>' <br>' Verify these two paths are correct<br>sMKVDKAbout = "d:\colls\tools\mkvdk-about.cmd"<br>sLogFolderPath = "d:\colls\tools\logfiles\"<br><br>' *******************************************************<br>' Main<br>' *******************************************************<br>' administrative work begins here<br>Call subBanner()<br>Call subParseArgs()<br>Call subCheckControlFolder(oArgs(0))<br>Call subCheckMKVDKAbout()<br>Call subCheckTempLogFolderDir(sLogFolderPath)<br>Call subBuildNames()<br><br>Call subBuildFolder(sMkvdkLogFolderPath)<br>Call subFlightCheck()<br><br>' real work begins below<br>Call subBuildControlDictionary(oArgs(0))<br>Call subCheckCollections(sCapture)<br>Call subFinish()<br><br>' *******************************************************<br>' Sub routines<br>' *******************************************************<br>Sub subCheckCollections(sTempLogFile)<br>'<br>' locate the collecitons and examine the parts directories<br>' and output from mkvdk -about<br>'<br>	Dim strCurrControlFile, strDrive, i,strText<br>	Dim oFolder, oFile, strControlRead, objTextFile<br>	Dim objFSO, arrControlLines, arrCollectionLine<br>	Dim strControlLine, strCollectionFolder<br><br>	strCurrControlFile = dictControlFiles.items<br>	For i = 0 To dictControlFiles.Count -1<br>		Wscript.echo " "<br>		wscript.echo "Working " &amp; strCurrControlFile(i)<br>		strDrive = WhichMapDrive(strCurrControlFile(i))<br>		if len(strDrive) &gt; 1 then<br>			wscript.echo "+ Setting local drive " &amp; strDrive<br><br>			Set objFSO = CreateObject("Scripting.FileSystemObject")<br>			strControlRead = oArgs(0) &amp; "\" &amp; strCurrControlFile(i)<br><br>			wscript.echo "+ Reading in control file " &amp; strControlRead<br>			Set objTextFile = objFSO.OpenTextFile(strControlRead, ForReading)<br>			strText = objTextFile.ReadAll<br>			objTextFile.Close<br><br>			' looking for extra white space<br>			' another proud VB moment<br>			' see this sweet hack used for inspiration<br>			' http://www.microsoft.com/technet/scriptcenter/resources/qanda/may05/hey0520.mspx<br>			intLength = Len(strText)<br>			strEnd = Right(strText, 2)<br>			If strEnd = vbCrLf Then<br>		    		strText = Left(strText, intLength - 2)<br>			End If<br><br>			wscript.echo "+ Parsing configuration from " &amp; strControlRead						<br>			arrControlLines = Split(strText, vbCrLf)<br>		<br>			For Each strControlLine in arrControlLines<br>			arrCollectionLine = split(strControlLine, ";")<br>			strServerName = arrCollectionLine(0)<br>			strCollectionFolder = arrCollectionLine(1)<br>			strCollectionPath =  strDrive &amp; "\" &amp; trim(strCollectionFolder)<br>			strCollectionPartsPath = strDrive &amp; "\" &amp; trim (strCollectionFolder) &amp; "\parts"			<br><br>				iDDD = 0<br>				iMrg = 0<br>				iDID = 0<br>				if DoesFolderExist(strCollectionPath) = 0 then<br>					wscript.echo "+ Working in " &amp; strCollectionPath<br>					wscript.echo "  " &amp; GetCollectionSize(strCollectionPartsPath) &amp;  " GB"<br>					wscript.echo"  Server " &amp; strServerName<br>					Set oFolder = fso.GetFolder(strCollectionPartsPath)<br>					iTotalFiles = 0<br>					for each oFile in oFolder.files<br>						if lcase(right(oFile, 3)) = "did" then<br>							iDID = iDID + 1<br>						end if<br>						if lcase(right(oFile, 3)) = "ddd" then<br>							iDDD = iDDD + 1<br>						end if<br>						if lcase(right(oFile, 3)) = "mrg" then<br>							iMrg = iMrg + 1<br>						end if<br>						iTotalFiles = iTotalFiles + 1<br>					next<br>					wscript.echo "  " &amp; iDDD &amp; " ddd files"<br>					wscript.echo "  " &amp; iMrg &amp; " mrg files"	<br>					wscript.echo "  " &amp; iDID &amp; " did files"					<br>					wscript.echo "  " &amp; iTotalFiles &amp; " total files"<br><br>					sTempLogFile = sMkvdkLogFolderPath &amp; "\" &amp; arrCollectionLine(1) &amp; ".log"<br>					wsoCommand = sMKVDKAbout &amp; " " &amp; strCollectionPath &amp; " " &amp;  sTempLogFile<br>					wscript.echo "  " &amp; "calling mkvdk"<br>					wsoReturn = wso.Run(wsoCommand,7,true)<br>					Set objTextFile = objFSO.OpenTextFile(sTempLogFile, ForReading)<br>					strText = objTextFile.ReadAll<br>					objTextFile.Close<br>					wscript.echo "+ Reading MKVDK Results "<br>					arrMKVDKLines = Split(strText, vbCrLf)<br>					For Each strMKVDKResult in arrMKVDKLines<br>						If InStr(strMKVDKResult, "Last Squeeze Date") Then<br>							wscript.echo "  " &amp; trim(strMKVDKREsult)<br>						End If<br>						If InStr(strMKVDKResult, "Number of Documents") Then<br>							wscript.echo "  " &amp; trim(strMKVDKREsult)<br>						End If<br>					Next				<br>				end if<br>			Next<br>		End if<br><br>	Next<br>End Sub<br><br>'<br>' Create a wsh directory structure that contains the names of all<br>' control files found in the directory given at run time<br>'<br>Sub subBuildControlDictionary(strControlFilePath)<br>	Dim oFolder, oFile<br>	Set oFolder = fso.GetFolder(strControlFilePath)<br>	Set dictControlFiles = CreateObject("Scripting.Dictionary")<br>	<br>	wscript.echo ""<br>	wscript.echo "Finding control files"<br>	i=0<br>	For Each oFile in oFolder.Files<br>		if left(oFile.Name, 4) = "ctl_" then<br>			Wscript.Echo "+ Found " &amp; oFile.Name<br>			dictControlFiles.add i, oFile.Name<br>			i = i + 1<br>		end if<br>	Next<br>	if i &lt; 1 then<br>		Wscript.Echo "Error:"<br>		Wscript.Echo "====================================="<br>		Wscript.Echo "Could not find control files in " &amp; oArgs(0)<br>		wscript.Echo ""<br>		Wscript.Quit 1<br>	End if<br>	if dictcontrolFiles.Count &gt; 4 then<br>		wscript.Echo ""<br>		wscript.echo "Configuration Alert"<br>		Wscript.Echo "====================================="<br>		Wscript.Echo "Found more than four control files."<br>		wscript.Echo "This script will continue, but may need to be modified."<br>		wscript.Echo ""<br>	end if<br>End Sub<br><br>Sub subParseArgs()<br>'<br>' read working directory from command line<br>'<br>	if oArgs.Count &lt; 1 then<br>		Wscript.Echo "Error:"<br>		Wscript.Echo "====================================="<br>		Wscript.Echo ""<br>		wscript.Echo "Requires path to control files"<br>		wscript.echo "used to handle operations"<br>		wscript.echo "with Verity collections"<br>		wscript.quit 1<br>	End if<br>	wscript.echo "+ Parsed arguments"<br>End Sub<br><br>Sub subFinish()<br>	wscript.echo ""<br>	wscript.echo "Script completed"<br>	wscript.echo "Start "&amp;  dtmDateNow &amp; " " &amp; dtmTimeNow<br>	wscript.echo "Stop " &amp; date &amp; " " &amp; Time<br>End Sub<br><br>Sub subFlightCheck()<br>'<br>' confirm that we're ready to go by giving user <br>' 10 seconds to break out of the script<br>'<br>	wscript.echo ""<br>	wscript.echo "You provided the following arguments"<br>	for i = 0 to oArgs.Count -1<br>		wscript.echo "     " &amp; oArgs(i)<br>	Next<br>	wscript.echo ""<br>	wscript.echo "Script will read control files found in "<br>	wscript.echo oArgs(0)<br>	wscript.echo "and try to determine their health"<br>	wscript.echo "====================================="<br>	wscript.echo "Hit Ctrl+C now to cancel."<br>	wscript.echo "Script resumes in 5 seconds"<br>	wscript.echo ""<br> 	wscript.sleep(5000)<br>End Sub<br><br>Sub subBanner()<br>	Wscript.echo ""<br>	Wscript.echo "orb-verity-health.vbs"<br>	wscript.echo "==================="<br>	wscript.echo "(c) based on code copyright (c) caseshare 2005"<br>	Wscript.echo ""<br>End Sub<br><br>Sub subCheckTempLogFolderDir(sFolderPath)<br>'<br>' Verify that the 'parent' log directory exists i<br>' or create it if it does not <br>'<br>If DoesFolderExist(sControlFilePath) = -1 Then<br>        Wscript.Echo "Warning:"<br>        Wscript.Echo "====================================="<br>        Wscript.Echo sFolderPath<br>        wscript.Echo "Folder does not exist; creating"<br><br>	If CreateTempLogFolder(sFolderPath) = -1 Then<br>	        Wscript.Echo "Error:"<br>	        Wscript.Echo "====================================="<br>	        Wscript.Echo sFolderPath &amp; " could not be created"<br>	        wscript.Echo ""<br>	        Wscript.Quit 1<br>	Else<br>	        wscript.echo "+ Temp log folder created " &amp; sFolderPath<br>	End If<br>	<br>Else<br>        wscript.echo "+ Control folder exists"<br>End if<br><br>End Sub<br><br><br>Sub subCheckControlFolder(sControlFilePath)<br>wscript.echo "in CheckControlFolder parm is " &amp; sFolderPath<br>If DoesFolderExist(sControlFilePath) = -1 Then<br>	Wscript.Echo "Error:"<br>	Wscript.Echo "====================================="<br>	Wscript.Echo oArgs(0)<br>	wscript.Echo "Folder does not exist"<br>	wscript.quit 1<br>Else<br>	wscript.echo "+ Control folder exists"<br>End if<br>End Sub<br><br><br>Sub subCheckMKVDKAbout()<br>If DoesFileExist(sMKVDKAbout) = -1 Then<br>	Wscript.Echo "Error:"<br>	Wscript.Echo "====================================="<br>	Wscript.Echo sMKVDKAbout &amp; " does not exist."<br>	wscript.Echo ""<br>	Wscript.Quit 1<br>Else<br>	wscript.echo "+ mkvdkAbout found"<br>End If<br>End Sub<br><br>Sub subCheckMKVDK()<br>If DoesFileExist(sMKVDK) = -1 Then<br>	Wscript.Echo "Error:"<br>	Wscript.Echo "====================================="<br>	Wscript.Echo sMKVDK &amp; " does not exist."<br>	wscript.Echo ""<br>	Wscript.Quit 1<br>Else<br>	wscript.echo "+ mkvdk found"<br>End If<br>End Sub<br><br>Sub subBuildFolder(sFolderPath)<br>If CreateTempLogFolder(sFolderPath) = -1 Then<br>	Wscript.Echo "Error:"<br>	Wscript.Echo "====================================="<br>	Wscript.Echo sFolderPath &amp; " could not be created"<br>	wscript.Echo ""<br>	Wscript.Quit 1<br>Else<br>	wscript.echo "+ Temp log folder created " &amp; sFolderPath<br>End If<br>	<br>End Sub<br><br>Sub subBuildNames()<br>	dtmDateNow = date<br>	dtmTimeNow = time<br><br>	dtmYYYY = DatePart("yyyy", dtmDateNow)<br>	dtmMM = DatePart("m", dtmDateNow)<br>	dtmDD = DatePart("d", dtmDateNow)<br>	dtmHH = DatePart("h", dtmTimeNow)<br>	dtmMN = DatePart("n", dtmTimeNow)<br>	dtmSS = DatePart("s", dtmTimeNow)<br><br>	If dtmMM &lt; 10 Then<br>		dtmMM = "0" &amp; dtmMM<br>	End if<br>	If dtmHH &lt; 10 Then<br>		dtmHH = "0" &amp; dtmHH<br>	End if<br>	If dtmMN &lt; 10 then<br>		dtmMN = "0" &amp; dtmMN<br>	End if<br>	If dtmDD &lt; 10 Then<br>		dtmDD = "0" &amp; dtmDD<br>	End if<br>	If dtmSS &lt; 10 Then<br>		dtmSS = "0" &amp; dtmSS<br>	End If<br>	sLogFolder = "_orb-" &amp; dtmYYYY &amp; dtmMM &amp; dtmDD &amp; dtmHH &amp; dtmMN &amp; dtmSS<br>	sMkvdkLogFolderPath = sLogFolderPath &amp; sLogFolder<br><br>End Sub<br><br><br>' *******************************************************<br>' functions<br>' *******************************************************<br>function WhichMapDrive(strFileName)<br>	if lcase(strFileName) = "ctl_ender.txt"  then<br>		whichMapDrive = ender<br>	End If<br>	if lcase(strFileName) = "ctl_bean.txt" then<br>		whichMapDrive = bean<br>	End If	<br>end function<br><br>function DoesFileExist(FilePath)<br>Dim fso<br>	Set fso = CreateObject("Scripting.FileSystemObject")<br>	if not fso.FileExists(FilePath) then<br>		DoesFileExist = -1<br>	else<br>		DoesFileExist = 0<br>	end if<br>	Set fso = Nothing<br><br>end function<br><br>function CreateTempLogFolder(sFolderPath)<br>Dim fso<br>	set fso = CreateObject("Scripting.FileSystemObject")<br>	if DoesFolderExist(sFolderPath) &lt; 0 then<br>		fso.CreateFolder(sFolderPath)<br>		if DoesFolderExist(sFolderPath) &lt; 0 then<br>			CreateTempLogFolder = -1<br>		else<br>			createTempLogFolder = 0<br>		end if<br>	else<br>		CreateTempLogFolder = 0<br>	end if<br>	set fso = nothing<br><br>end function<br><br>function DoesFolderExist(FolderPath)<br>Dim fso<br><br>	Set fso = CreateObject("Scripting.FileSystemObject")<br>	If not fso.FolderExists(FolderPath) Then<br>		DoesFolderExist = -1<br>   	else<br>     		DoesFolderExist = 0<br>	end if<br>	Set fso = Nothing<br><br>End Function<br><br>function GetCollectionSize(CollPath)<br>Dim s, oFolder, oFolderItem, fso, wso<br><br>	s = -1<br>	Set fso = CreateObject("Scripting.F